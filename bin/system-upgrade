#!/usr/bin/env bash

is_sudo() {
  local group="sudo"
  if id -nG "${USER}" | grep -qw "${group}"; then
    return 0
  else
    return 1
  fi
}

brew_package_version() {
  local package
  local brew_prefix
  local version

  package="$1"
  brew_prefix="^$(brew --prefix)/Cellar"
  version=$(brew info "${package}" | grep "${brew_prefix}" | awk -F "${brew_prefix}/" '{print $2}' | awk -F '/| ' '{print $2}')

  # "return" a string value
  echo "${version}"
}

is_head() {
  local version
  version=$(brew_package_version "$1")
  [[ "${version}" =~ ^HEAD ]] && return 0 || return 1
}

update_repositories() {
    # https://stackoverflow.com/questions/24628076/bash-convert-n-delimited-strings-into-array
    # https://unix.stackexchange.com/questions/92187/setting-ifs-for-a-single-statement

    # https://unix.stackexchange.com/questions/12902/how-to-run-find-exec
    # https://stackoverflow.com/questions/27658675/how-to-remove-last-n-characters-from-a-string-in-bash

    local GIT_REPOSITORIES
    SAVEIFS=${IFS}  # Save current IFS
    IFS=$'\n'       # Change IFS to new line
    GIT_REPOSITORIES=($(find . -type d -iname '*.git' -exec bash -c 'path_with_ext="{}"; path=${path_with_ext%/.*} && echo ${path}' \; | grep -v "./local\|^.$" | sort))

    echo "Following git sub-repositories will be processed: ${GIT_REPOSITORIES[@]}"
    local CURDIR; CURDIR=$(pwd)
    local TIMEOUT=10s
    for REPOSITORY in "${GIT_REPOSITORIES[@]}"
    do
      echo "Processing repository ${REPOSITORY}"
      cd "${REPOSITORY}" && (
      timeout --kill-after ${TIMEOUT} --signal=HUP ${TIMEOUT} git fetch --all && \
      timeout --kill-after ${TIMEOUT} --signal=HUP ${TIMEOUT} git pull && \
      timeout --kill-after ${TIMEOUT} --signal=HUP ${TIMEOUT} git submodule foreach 'git pull || :' >/dev/null 2>&1
      )
      cd "${CURDIR}"
    done
    IFS=${SAVEIFS}  # Restore IFS
}

cd ~/.dotfiles && update_repositories

# # zim update
# zsh ${ZIM_HOME}/tools/zim_update
# source ${ZIM_HOME}/tools/zim_clean_cache


case $OSTYPE in
linux*)
  if is_sudo; then
    sudo bash -c 'apt-get update && apt-get -yqq upgrade && apt-get -yqq autoremove && apt-get clean all'
    sudo chgrp -R brew /home/linuxbrew
    sudo chmod -R g+w  /home/linuxbrew
    sudo chgrp -R brew "$(brew --prefix)/"
    sudo chmod -R g+w  "$(brew --prefix)/"
    sudo chmod -R u+w  "$(brew --prefix)/"
  fi
  ;;
esac

# brew
brew update
brew upgrade

PACKAGES=( \
  mosh \
  tmux \
  neovim \
)
for PACKAGE in "${PACKAGES[@]}"; do
  is_head "${PACKAGE}" && brew reinstall "${PACKAGE}"
done

brew cleanup --prune all --verbose

~/.dotfiles/bin/get-docker-compose
# ~/.dotfiles/bin/reinstall-nvim
